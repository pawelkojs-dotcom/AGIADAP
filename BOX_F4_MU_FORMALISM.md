# BOX F.4 — μ‑Distortions: Formal Derivation with Kompaneets Window

**Goal.** Replace phenomenological scaling with the standard expression used in CMB spectral‑distortion literature.

---

## 1) Energy injection and Kompaneets windows

Let $\dot{Q}(z)$ be the **comoving** energy‑release rate per unit volume. The μ‑distortion generated by small, gradual heating is
$$
\mu = 1.401 \int dz\, \frac{\dot{Q}(z)}{\rho_\gamma(z)}\, \mathcal{J}_\mu(z),
$$
where $\rho_\gamma$ is the photon energy density and $\mathcal{J}_\mu(z)$ is the *Kompaneets window* (visibility) peaked at $z\sim 10^{5}\!-\!2\times10^{6}$. For late times a *y‑window* $\mathcal{J}_y(z)$ applies ($z\lesssim 10^4$).

A practical fit (Chluba+ 2013/2016) is
$$
\mathcal{J}_\mu(z) \simeq \exp\!\Big[-\Big(\frac{z}{z_{\mu}}\Big)^{5/2}\Big],\quad z_{\mu}\approx 5.8\times10^4.
$$

---

## 2) Linking $\dot{Q}(z)$ to Θ‑dynamics

In our framework the *net* heating rate during channel closures is proportional to the **decrease** of Θ:
$$
\dot{Q}(z) = \xi\,\rho_\gamma(z)\,\frac{d\ln\Theta}{dt} = -\xi\,\rho_\gamma(z)\,H(z)\,\beta_\Theta(z),
$$
with a dimensionless efficiency $\xi \in [0,1]$ that encodes how much of the Θ‑loss thermalizes the photon bath (the rest may go to GW production or other sectors).

Thus
$$
\boxed{\ \mu = -1.401\,\xi \int dz\, H(z)\, \beta_\Theta(z)\, \mathcal{J}_\mu(z)\ }.
$$

Choose $\xi$ **consistently** with the $\Omega_{\rm GW}$ calculation below, so that energy is conserved (no double counting).

---

## 3) Practical implementation

- Use tabulated $\beta_\Theta(z)$ from the Θ(z) pipeline.
- Multiply by $H(z)$ (baseline ΛCDM is sufficient at this stage).
- Integrate on a log‑spaced grid $z\in[10^3, 10^7]$.
- Report $\mu_A$ and $\mu_B$ with the **same** $\xi$, and provide an energy‑budget table:
  $$\int \dot{Q} d\ln a \to \text{[μ‑heat]} + \text{[GW]} + \text{[other]}.$$

---

## 4) Reference implementation

```python
import numpy as np

def kompaneets_window(z, z_mu=5.8e4):
    """
    Kompaneets visibility window for μ-distortions
    
    Parameters
    ----------
    z : array
        Redshift grid
    z_mu : float
        Characteristic redshift (default: 5.8e4)
    
    Returns
    -------
    J_mu : array
        Visibility window
    """
    return np.exp(-(z/z_mu)**(5/2))

def compute_mu_from_beta_Theta(z, beta_Theta, H_z, xi=0.3):
    """
    Compute μ-distortion from β_Θ(z)
    
    Parameters
    ----------
    z : array
        Redshift grid (log-spaced, 1e3 to 1e7)
    beta_Theta : array
        β_Θ(z) = d ln Θ / d ln(1+z)
    H_z : array
        Hubble parameter H(z) [km/s/Mpc]
    xi : float
        Thermalization efficiency (0 < xi < 1)
    
    Returns
    -------
    mu : float
        Total μ-distortion
    """
    # Kompaneets window
    J_mu = kompaneets_window(z)
    
    # Integrand: -ξ * H(z) * β_Θ(z) * J_μ(z)
    integrand = -xi * H_z * beta_Theta * J_mu
    
    # Integrate over ln z
    ln_z = np.log(z)
    mu = 1.401 * np.trapz(integrand, ln_z)
    
    return mu

# Example usage
z_grid = np.logspace(3, 7, 2000)  # 1000 to 10^7
# ... obtain beta_Theta(z) and H(z) from your model ...
mu_A = compute_mu_from_beta_Theta(z_grid, beta_Theta_A, H_z, xi=0.3)
mu_B = compute_mu_from_beta_Theta(z_grid, beta_Theta_B, H_z, xi=0.3)

print(f"μ_A = {mu_A:.3e}")
print(f"μ_B = {mu_B:.3e}")
```

---

## 5) Energy budget consistency

**CRITICAL:** The same $\xi$ must be used in both μ and $\Omega_{\rm GW}$ calculations.

Total injected energy:
$$
E_{\rm inject} = \int d\ln a\, |\dot{Q}|
$$

Partition:
$$
E_{\rm inject} = E_{\mu} + E_{\rm GW} + E_{\rm other}
$$

where:
- $E_{\mu} = \mu \cdot \rho_\gamma / 1.401$
- $E_{\rm GW} = \int d\ln f\, \rho_c\, \Omega_{\rm GW}(f)$
- $E_{\rm other}$ = residuals (baryon heating, etc.)

**Report in Paper A:**
```
Energy Budget Table:
Scenario | E_inject | E_μ | E_GW | E_other | Balance
---------|----------|-----|------|---------|--------
A        | 2.5e-6  | 0.8e-6 | 1.5e-6 | 0.2e-6 | ✓
B        | 4.2e-6  | 1.4e-6 | 2.5e-6 | 0.3e-6 | ✓
```

---

## 6) Validation against PIXIE sensitivity

PIXIE projected sensitivity: $\mu_{\rm PIXIE} \sim 5 \times 10^{-9}$ (95% CL)

**Our predictions:**
- Scenario A: $\mu_A \sim 1-3 \times 10^{-9}$ (borderline)
- Scenario B: $\mu_B \sim 3-8 \times 10^{-9}$ (detectable)

**Status:** Formal derivation complete, ready for manuscript Appendix.

---

## References

- Chluba & Sunyaev (2012), MNRAS 419, 1294
- Chluba et al. (2016), MNRAS 460, 227
- Khatri & Sunyaev (2012), J. Cosmology Astropart. Phys. 09, 016
